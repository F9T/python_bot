<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>moviebot &mdash; MovieBot 1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MovieBot 1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for moviebot</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Movie Bot : a Slack bot using asyncio</span>

<span class="sd">This bot</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">aiohttp</span>

<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlencode</span>

<span class="kn">from</span> <span class="nn">moviebot.config</span> <span class="kn">import</span> <span class="n">DEBUG</span><span class="p">,</span> <span class="n">TOKEN</span><span class="p">,</span> <span class="n">API_KEY</span>

<span class="n">RUNNING</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># URL for poster</span>
<span class="c1"># https://image.tmdb.org/t/p/w396/</span>

<div class="viewcode-block" id="MovieBot"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot">[docs]</a><span class="k">class</span> <span class="nc">MovieBot</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__doc__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Movie Bot</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">TOKEN</span><span class="p">,</span> <span class="n">api_key</span> <span class="o">=</span> <span class="n">API_KEY</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rtm</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;help&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span><span class="p">,</span>
            <span class="s2">&quot;movie&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchMovie</span>
            <span class="c1"># &quot;person&quot; : self.searchPerson,</span>
            <span class="c1"># &quot;series&quot; : self.searchSeries</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://api.themoviedb.org/3/search/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urlImage</span> <span class="o">=</span> <span class="s1">&#39;https://image.tmdb.org/t/p/w396/&#39;</span>

<div class="viewcode-block" id="MovieBot.help"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.help">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display help message&quot;&quot;&quot;</span>
        <span class="n">helpMsg</span> <span class="o">=</span> <span class="s1">&#39;Movie Bot help !</span><span class="se">\n</span><span class="s1">&#39;</span> \
                  <span class="s1">&#39; - _movie &quot;title&quot;_ : Search for movies by title.</span><span class="se">\n</span><span class="s1">&#39;</span> \
                  <span class="s1">&#39; - _person &quot;name&quot;_ : Search for people by name.</span><span class="se">\n</span><span class="s1">&#39;</span> \
                  <span class="s1">&#39; - _serie &quot;title&quot;_ : Search for TV shows by title.</span><span class="se">\n</span><span class="s1">&#39;</span> \
                  <span class="s1">&#39; - _help_ : Need help?&#39;</span>
        <span class="k">return</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">helpMsg</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="MovieBot.searchMovie"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.searchMovie">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">searchMovie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search a movie.&quot;&quot;&quot;</span>
        <span class="n">datas</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestApiTmdb</span><span class="p">(</span><span class="s1">&#39;movie&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">movieMsg</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datas</span><span class="p">:</span>
            <span class="n">title</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
            <span class="n">overview</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;overview&#39;</span><span class="p">]</span>
            <span class="n">date</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;release_date&#39;</span><span class="p">]</span>
            <span class="n">poster</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;poster_path&#39;</span><span class="p">]</span>
            <span class="n">lang</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;original_language&#39;</span><span class="p">]</span>
            <span class="n">note</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vote_average&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;/10&quot;</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">overview</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">movieMsg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;{0} - {1} - {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">note</span><span class="p">)),</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overview</span><span class="p">)),</span> <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;{0}{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urlImage</span><span class="p">,</span> <span class="n">poster</span><span class="p">))}])</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">movieMsg</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>
<span class="c1">#{&#39;genre_ids&#39;: [16, 12, 10751], &#39;poster_path&#39;: &#39;/bpwcrF7FExuLa2a54L7nwnwpPz4.jpg&#39;, &#39;vote_average&#39;: 7.53, &#39;id&#39;: 109445, &#39;video&#39;: False, &#39;vote_count&#39;: 2862, &#39;popularity&#39;: 4.971505, &#39;original_language&#39;: &#39;en&#39;, &#39;title&#39;: &#39;La Reine des neiges&#39;, &#39;adult&#39;: False, &#39;backdrop_path&#39;: &#39;/irHmdlkdJphmk4HPfyAQfklKMbY.jpg&#39;, &#39;overview&#39;: &#39;Anna, une jeune fille aussi audacieuse qu’optimiste, se lance dans un incroyable voyage en compagnie de Kristoff, un montagnard expérimenté, et de son fidèle renne, Sven à la recherche de sa sœur, Elsa, la Reine des neiges qui a plongé le royaume d’Arendelle dans un hiver éternel…  En chemin, ils vont rencontrer de mystérieux trolls et un drôle de bonhomme de neige nommé Olaf, braver les conditions extrêmes des sommets escarpés et glacés, et affronter la magie qui les guette à chaque pas.&#39;, &#39;release_date&#39;: &#39;2013-11-27&#39;, &#39;original_title&#39;: &#39;Frozen&#39;}</span>


<div class="viewcode-block" id="MovieBot.searchPerson"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.searchPerson">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">searchPerson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search a person.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestApiTmdb</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MovieBot.searchSeries"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.searchSeries">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">searchSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Search a serie.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">requestApiTmdb</span><span class="p">(</span><span class="s1">&#39;movie&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="MovieBot.requestApiTmdb"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.requestApiTmdb">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">requestApiTmdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a API call to The Movie Data Base&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">({</span><span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span> <span class="p">:</span> <span class="s1">&#39;fr&#39;</span><span class="p">})</span>
            <span class="n">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="MovieBot.send"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.send">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="n">isAttachment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sending message to Slack.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isAttachment</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">await</span> <span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;chat.postMessage&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel_id</span><span class="p">,</span>
                                                   <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                                   <span class="s1">&#39;attachment&#39;</span>
                                                   <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="n">team_id</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">await</span> <span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;chat.postMessage&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="n">channel_id</span><span class="p">,</span>
                                                   <span class="s1">&#39;attachments&#39;</span><span class="p">:</span> <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">),</span>
                                                   <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="n">team_id</span><span class="p">})</span></div>


<div class="viewcode-block" id="MovieBot.receive"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.receive">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Receive message from Slack&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span>

            <span class="c1"># Channel ID</span>
            <span class="n">channel_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">)</span>
            <span class="c1"># Team ID</span>
            <span class="n">team_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtm</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="c1"># Bot ID</span>
            <span class="n">bot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtm</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="c1"># THE Message</span>
            <span class="n">message_text</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>

            <span class="c1"># Splits message in half, with recipient on the left side, and the core text on the other.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">message_text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="n">message_split</span> <span class="o">=</span> <span class="n">message_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">recipient</span> <span class="o">=</span> <span class="n">message_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># Check if message is adressed to this bot</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">recipient</span> <span class="o">==</span> <span class="s1">&#39;&lt;@{0}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bot_id</span><span class="p">):</span>
                    <span class="n">core_text</span> <span class="o">=</span> <span class="n">message_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">core_text_split</span> <span class="o">=</span> <span class="n">core_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="c1"># The default action is help</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="c1"># Check if a query exist</span>
                    <span class="c1"># - If exist then get the action and the query</span>
                    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">core_text_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">command</span> <span class="o">=</span> <span class="n">core_text_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="n">core_text_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">help</span>

                    <span class="n">await</span> <span class="n">action</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">team_id</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="MovieBot.connect"><a class="viewcode-back" href="../moviebot_class.html#moviebot.MovieBot.connect">[docs]</a>    <span class="n">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Joins Slack.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rtm</span> <span class="o">=</span> <span class="n">await</span> <span class="n">api_call</span><span class="p">(</span><span class="s2">&quot;rtm.start&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtm</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">],</span> <span class="s2">&quot;Error connecting to RTM.&quot;</span>

        <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">ws_connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rtm</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span> <span class="k">as</span> <span class="n">ws</span><span class="p">:</span>
                <span class="n">async</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">msg</span><span class="o">.</span><span class="n">tp</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">MsgType</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="n">message</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="api_call"><a class="viewcode-back" href="../moviebot_functions.html#moviebot.api_call">[docs]</a><span class="n">async</span> <span class="k">def</span> <span class="nf">api_call</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">TOKEN</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform an API call to Slack.</span>
<span class="sd">   :param method: Slack API method name.</span>
<span class="sd">   :param type: str</span>
<span class="sd">   :param data: Form data to be sent.</span>
<span class="sd">   :param type: dict</span>
<span class="sd">   :param file: file pointer to send (for files.upload).</span>
<span class="sd">   :param type: file</span>
<span class="sd">   :param token: OAuth2 tokn</span>
<span class="sd">   :param type: str</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">FormData</span><span class="p">(</span><span class="n">data</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">form</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://slack.com/api/{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">form</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="k">assert</span> <span class="mi">200</span> <span class="o">==</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;{0} with {1} failed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>


<div class="viewcode-block" id="stop"><a class="viewcode-back" href="../moviebot_functions.html#moviebot.stop">[docs]</a><span class="k">def</span> <span class="nf">stop</span><span class="p">():</span>
   <span class="sd">&quot;&quot;&quot;Gracefully stop the bot.&quot;&quot;&quot;</span>
   <span class="k">global</span> <span class="n">RUNNING</span>
   <span class="n">RUNNING</span> <span class="o">=</span> <span class="bp">False</span>
   <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Stopping... closing connections.&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
   <span class="n">loop</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span>
   <span class="n">bot</span> <span class="o">=</span> <span class="n">MovieBot</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">,</span> <span class="n">API_KEY</span><span class="p">)</span>
   <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
   <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Lovis Thomas & Rodrigues L. Daniel.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>